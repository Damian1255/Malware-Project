import os
import pandas as pd
import logging
import imports.extractor as extractor

# Set up logging
logging.basicConfig(level=logging.INFO)

def main(root_folder_name='malwares', output_file='malware_features.csv'):
    features_dict = {}
    folders = os.listdir(root_folder_name)

    # Iterate through the folders in the root folder and extract features for each item
    for folder in folders:
        folder_path = os.path.join(root_folder_name, folder)
        items = os.listdir(folder_path)

        # Skip if the folder is empty
        if not items:
            continue
        
        # Extract features for each item in the folder
        for item in items:
            item_url = os.path.join(folder_path, item)
            try:
                features = extractor.extract_features(item_url)
                if features is not None:
                    features_dict[item] = features
                    logging.info(' Extracted features from %s', item_url)
                else:
                    logging.error(' Cannot extract features from %s', item_url)
            except Exception as e:
                logging.error(' Exception occurred while extracting features from %s: %s', item_url, str(e))

    # Convert the dictionary to a DataFrame and save to a CSV file
    logging.info(' Saving features to %s', output_file)
    df = pd.DataFrame.from_dict(features_dict, orient='index')
    df.to_csv(output_file, index=False)


if __name__ == '__main__':
    main()