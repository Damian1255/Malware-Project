import os
import sys
import pybinlex
import pandas as pd

resume_mode = False

# Specify the root folder name
root_folder_name = 'org'

# get the failed logs
failed_logs = []
with open('binlex/failed_logs.txt', 'r') as f:
    failed_logs = f.read().splitlines()

# check if 'END' is in the failed logs to stop the script
if 'END' in failed_logs:
    print('All files have been processed')
    sys.exit()

if len(failed_logs) > 0:
    resume_mode = True
    last_line = failed_logs[-1].split('\\')
    resume_root_folder_name = last_line[1]
    resume_file_name = last_line[-1]

# Check if the specified root folder exists
files = os.listdir(root_folder_name)

# Iterate through the files in the root folder
for file in files:
    if resume_mode and file != resume_root_folder_name:
        continue

    file_path = os.path.join(root_folder_name, file)

    # Skip if the item is not a folder
    if not os.path.isdir(file_path):
        continue

    # Get all the items in the folder
    items = os.listdir(file_path)

    for item in items:
        if resume_mode and item != resume_file_name:
            continue
        else:
            resume_mode = False

        try:
            item_path = os.path.join(file_path, item)

            # Skip if is in the failed logs
            if item_path in failed_logs:
                continue

            # write directory to fail logs
            with open('binlex/failed_logs.txt', 'a') as f:
                f.write(item_path + '\n')

            # Read the file
            pe = pybinlex.PE()
            result = pe.read_file(item_path)

            # Disassemble the file
            disassembler = pybinlex.Disassembler(pe)
            disassembler.disassemble()

            # Get the traits of the file
            traits = disassembler.get_traits()
            
            print(f'Extracted traits from {item_path}')
            
            # convert the traits to a pandas DataFrame
            df = pd.DataFrame(traits)
            
            # append the folder name to the DataFrame
            df['family'] = file
            df['file_name'] = item

            # drop the unnecessary columns
            df.drop(['tags', 'bytes_sha256', 'bytes_entropy', 'trait_sha256'], axis=1, inplace=True)
                              
            # check if traits.csv exists
            if not os.path.exists('binlex/traits.csv'):
                # convert the traits to a pandas DataFrame and concatenate it to the main DataFrame
                df.to_csv('binlex/traits.csv', index=False)
            else:
                traits_df = pd.read_csv('binlex/traits.csv')
                traits_df = pd.concat([traits_df, df], ignore_index=True)
                traits_df.to_csv('binlex/traits.csv', index=False)

            # remove the last row in the failed logs
            with open('binlex/failed_logs.txt', 'r') as f:
                lines = f.read().splitlines()

            # remove the last line
            lines = lines[:-1]

            # write the new failed logs
            with open('binlex/failed_logs.txt', 'w') as f:
                for line in lines:
                    f.write(line + '\n')
    
        except Exception as e:
            print(f'Error: {e}')
            continue

# write ending to failed logs
with open('binlex/failed_logs.txt', 'a') as f:
    f.write('END\n')
